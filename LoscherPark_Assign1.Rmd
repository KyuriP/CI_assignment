---
title: "Causal Inference - Assignment 1"
author: "Emilia Löscher & Kyuri Park"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---

#1. Draw a DAG representing a simple and fairly plausible causal system from your preferred topic of choice.    

We chose the topic of obsessive-compulsive disorder (OCD) and it's relationship to depression symtoms. Our DAG is inspired by the paper "Co-morbid obsessive–compulsive disorder and depression: a Bayesian network approach" by R. J. McNally, P. Mair, B. L. Mugno and B. C. Riemann published in 2017. We broke down the DAG presented on page 1211 to only include 7 variables and constructed the variables according to the DAG and common sense.  

```{r}
library(qgraph)
library("pcalg")

varnames <- c("OCDint", "OCDdist", "OCDcont", "sad", "insom", "concen", "guilt")


# Adj <- matrix(c(0,1,0,0,0,1,0,
#                 0,0,1,1,0,0,0,
#                 0,0,0,1,0,0,0,
#                 0,0,0,0,1,0,1,
#                 0,0,0,0,0,1,0,
#                 0,0,0,0,0,0,1,
#                 0,0,0,0,0,0,0), 7,7, byrow = TRUE, dimnames = list(varnames, varnames))
# 
# qgraph(Adj, labels = varnames)

library(ggdag)
ocd <- dagify(
    guilt ~ concen + sad,
    concen ~ OCDint + insom,
    insom ~ sad,
    sad ~ OCDdist + OCDcont,
    OCDcont ~ OCDdist,
    OCDdist ~ OCDint,
    exposure = "OCDdist", #cause
    outcome = "guilt" #effect
    #optional: give co-ordinates
    #coords = list(x = c(X = -1, Y = 1, Z = 0),
    #            y = c(X = 0, Y = 0, Z = 1)) 
)

ggdag_status(ocd) + theme_dag()


```



#2. Specify a structural causal model for your DAG       
In the following, the structural causal model for our DAG is specified:
$OCDint  := \epsilon_{ODCint}$ 
$OCDdist := 3 * OCDint + \epsilon_{ODCdist}$
$OCDcon := 4 * OCDdis + \epsilon_{ODCcon}$
$sad := 2 * OCDdistress + 1 * OCDcontrol + \epsilon_{sad}$
$insomnia := 2 * sad + \epsilon_{insom}$
$concen :=  1 * OCDint + 4 * insom + \epsilon_{concen}$
$guilt := 1 * concen + 1 * sad + \epsilon_{guilt}$

where $\epsilon_{ODCint}, \ldots, \epsilon_{guilt} \sim N(0 , SD_{i})$ with $i \in \{ OCDint, \ldots, guilt}$ 

The standard deviations ($SD_{i}$ for $i \in \{ OCDint, \ldots, guilt}$) are taken from Table 1 on page 1206 in the paper. The same holds for the mean in the errors for the variabel $OCDint$. 

We came up with the intercept and regression coefficients ourselves. To determine them, we took the DAG and the thickness of the arrows on page 1211 into account and adjusted them to the DAG we chose.

#3. Set a seed in R. Generate data from your SCM with a sample size of 500 units     
```{r}
# Setting a seed 
set.seed(1705)

# Defining the sample size
n <- 500

#Generating Data
#with means
OCDint <- rnorm(n, 2.69, 0.82)
OCDdist <- 3 * OCDint + rnorm(n, 2.81, 0.76)
OCDcont <- 4 * OCDdist + rnorm(n, 2.67, 0.76)
sad <- 2 * OCDdist + 1 * OCDcont + rnorm(n, 1.55, 0.94)
insom <- 2 * sad + rnorm(n, 0.81, 1.07)
concen <-  1 * OCDint + 4 * insom + rnorm(n, 1.48, 0.87)
guilt <- 1 * concen + 1 * sad + rnorm(n, 1.56, 1.17)


 
# Setting a seed 
set.seed(1705)

# Defining the sample size
n <- 500

#Generating the data
#with means = 0
OCDint <- rnorm(n, 0, 0.82)
OCDdist <- 3 * OCDint + rnorm(n, 0, 0.76)
OCDcont <- 4 * OCDdist + rnorm(n, 0, 0.76)
sad <- 2 * OCDdist + 1 * OCDcont + rnorm(n, 0, 0.94)
insom <- 2 * sad + rnorm(n, 0, 1.07)
concen <-  1 * OCDint + 4 * insom + rnorm(n, 0, 0.87)
guilt <- 1 * concen + 1 * sad + rnorm(n, 0, 1.17)

#Creating the data set
OCDdata <- data.frame(OCDint, OCDdist, OCDcont, sad, insom, concen, guilt)

```

#4. Use the PC-algorithm on the generated data to ‘discover’ the structure of your causal system   
a. Is your true DAG covered in the Markov equivalence class provided by the algorithm?    
Estimate the CPDAG
```{r}
suffStat_OCD <- list(C = cor(OCDdata), n = nrow(OCDdata))

pc_OCD <- pc(suffStat = suffStat_OCD, indepTest = gaussCItest, p = ncol(OCDdata), alpha = 0.01)

plot(pc_OCD, main = " Inferred CPDAG using pcalg")
```
No?!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


b. Provide the CP-DAG. To what extent did the procedure correctly recover which relationship were absent/present/directed? 
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

#5. data. Choose two variables for which they should estimate the causal relationship    
a. Cause variable:   
OCDdist   
b. Outcome variable:    
guilt


#6. For the causal effect specified in 5    
a. What is the true causal effect of the cause on the outcome variable based on your SCM?    
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
```{r}
 1 * 2 + 1 * 4 * 2 * 2 + 1 * 1 * 4
```

22?

b. Based on the true DAG, what linear regression model should be used to estimate the causal effect correctly?   
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
```{r}
mod_OCD <- lm(guilt ~ OCDdist + OCDint, data = OCDdata)
summary(mod_OCD)
```
?

c. Estimate the causal effect with this regression model based on your generated data. To what extent is the true effect recovered?     
```{r}
cpdag_mat_OCD <- as(pc_OCD,"matrix")

# Each row is a DAG adjacency matrix in vector form (by rows)
res_OCD <- pdag2allDags(cpdag_mat_OCD)

# We can get the adjacency matrix of an individual DAG using
resOCD_dags <- list()
for(i in 1:nrow(res_OCD$dags)){
  resOCD_dags[[i]] <- t(matrix(res_OCD$dags[i,],7,7,byrow = TRUE))
}


ida(2,7, cov(OCDdata), pc_OCD@graph, verbose = TRUE)
```
The third CP-DAG does a good job?!
```{r}
res_Adj <- resOCD_dags[[3]]

qgraph(res_Adj)
```



#7. We will need a dichotomous cause variable    
a. Make a dichotomized version of the cause variable from question 5&6 in your dataset, for example by assigning scores lower than the mean a 0 and the rest a 1.    

```{r}
#Dichtomizing the effect variable OCDdist
mean_OCDdist <- mean(OCDdistress)
OCDdist_d <- rep(1, length(OCDdistress))
OCDdist_d[which(OCDdistress < mean_OCDdist)] <- 0

OCDdata <- cbind(OCDdata, OCDdist_d)

```

b. Use the correct model for the causal effect (the one from 6b) to estimate the causal effect again, but now with your dichotomized cause variable. Discuss the results.   
```{r}
mod_OCD_d <- lm(guilt ~ OCDdist_d + OCDint, data = OCDdata)
summary(mod_OCD_d)
```

?


#8. Prepare the data for the second causal inference assignment   
a. Create a data frame with all your variables    
```{r}
save(OCDdata, file = "LoscherPark_Assign1_Data.RData")
```

b. Make a brief .txt file   
See LoscherPark_Assign1.txt.










